version: '3.9'

services:
  backend:
    image: node:20
    container_name: talentsync-server
    working_dir: /app
    volumes:
      - ./server:/app:cached
      # keep node_modules isolated inside container (anonymous volume)
      - /app/node_modules
    environment:
      - MONGO_URL=${MONGO_URL}
    ports:
      - "5000:5000"
    restart: unless-stopped
    command: sh -c "npm ci --prefer-offline --no-audit --progress=false && npm run start || npm start"

  frontend:
    image: nginx:stable-alpine
    container_name: talentsync-client
    depends_on:
      - backend
    ports:
      - "80:80"
    volumes:
      # serve the built React app from client/build
      - ./client/build:/usr/share/nginx/html:ro
      # custom nginx config (optional)
      - ./client/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

networks:
  default:
    driver: bridge
version: '3.8'

services:
  backend-jenkins:
    image: node:20-slim
    container_name: talentsync-backend-jenkins
    working_dir: /workspace/server
    volumes:
      - ./server:/workspace/server:delegated
      - /workspace/server/node_modules
    command: sh -c "npm install --no-audit --no-fund && npm run start"
    ports:
      - "5100:5000"
    environment:
      - MONGO_URL=${MONGO_URL}
    restart: unless-stopped

  frontend-jenkins:
    image: node:20-slim
    container_name: talentsync-frontend-jenkins
    working_dir: /workspace/client
    volumes:
      - ./client:/workspace/client:delegated
      - /workspace/client/node_modules
      - ./client/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    command: sh -c "npm install --no-audit --no-fund && npm run build && npx serve -s build -l 8080"
    ports:
      - "8080:8080"
    depends_on:
      - backend-jenkins
    restart: unless-stopped
