#############################################################
# Jenkins-only docker-compose file
# Purpose: used by the Jenkins pipeline to run build/test steps inside containers
# and to provide short-lived containers for build verification.
# This is NOT the production compose file. The repo should keep a separate
# `docker-compose.yml` for production deployments (serves built app via nginx).
#############################################################
version: '3.8'

services:
  backend-jenkins:
    image: node:20-slim
    container_name: talentsync-backend-jenkins
    working_dir: /workspace/server
    # Mount repo server folder into the container so Jenkins can run installs/builds inside it
    volumes:
      - ./server:/workspace/server:delegated
      # keep node_modules inside the container filesystem (anonymous volume)
      - /workspace/server/node_modules
    command: sh -c "npm ci --prefer-offline --no-audit --progress=false && npm run start"
    ports:
      - "5100:5000"
    environment:
      - MONGO_URL=${MONGO_URL}
    restart: unless-stopped

  frontend-jenkins:
    image: node:20-slim
    container_name: talentsync-frontend-jenkins
    working_dir: /workspace/client
    volumes:
      - ./client:/workspace/client:delegated
      - /workspace/client/node_modules
    # Build the client inside the container and serve the built assets with `serve` for quick validation
    command: sh -c "npm ci --prefer-offline --no-audit --progress=false && npm run build && npx serve -s build -l 8080"
    ports:
      - "8081:8080"
    depends_on:
      - backend-jenkins
    restart: unless-stopped

networks:
  default:
    driver: bridge
